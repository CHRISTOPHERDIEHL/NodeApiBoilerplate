/*
 * http-test.js: Tests for instances of the HTTP transport
 *
 * MIT LICENSE
 */

var path = require('path'),
    vows = require('vows'),
    http = require('http'),
    fs = require('fs'),
    assert = require('assert'),
    winston = require('../../lib/winston'),
    helpers = require('../helpers'),
    hock = require('hock');

var transport = require('./transport');

var host = '127.0.0.1';

vows.describe('winston/transports/http').addBatch(***REMOVED***
  "When the HTTP endpoint": ***REMOVED***
    topic: function () ***REMOVED***
      var mock = this.mock = hock.createHock(),
          self = this;

        mock
          .post('/log', ***REMOVED***
            "method":"collect",
            "params":***REMOVED***
              "level":"info",
              "message":"hello",
              "meta":***REMOVED******REMOVED***
            ***REMOVED***
          ***REMOVED***)
          .min(1)
          .max(1)
          .reply(200);

      var server = this.server = http.createServer(mock.handler);
      server.listen(0, '0.0.0.0', this.callback);
    ***REMOVED***,
    "is running": function (err) ***REMOVED***
      assert.ifError(err);
    ***REMOVED***,
    "an instance of the Http transport": ***REMOVED***
      topic: function () ***REMOVED***

      var port = this.server.address().port;
        var self = this,
            httpTransport = new (winston.transports.Http)(***REMOVED***
              host: host,
              port: port,
              path: 'log'
            ***REMOVED***);

        httpTransport.log('info', 'hello', function (logErr, logged) ***REMOVED***
          self.mock.done(function (doneErr) ***REMOVED***
            self.callback(null, logErr, logged, doneErr);
          ***REMOVED***);
        ***REMOVED***);
      ***REMOVED***,
      "should log to the specified URL": function (_, err, logged, requested) ***REMOVED***
        assert.ifError(err);
        assert.isTrue(logged);
        assert.ifError(requested);
        this.server.close();
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***
***REMOVED***).export(module);
