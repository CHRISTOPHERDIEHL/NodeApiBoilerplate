/*
 * console-test.js: Tests for instances of the Console transport
 *
 * (C) 2010 Charlie Robbins
 * MIT LICENSE
 *
 */

var path = require('path'),
    vows = require('vows'),
    assert = require('assert'),
    winston = require('../../lib/winston'),
    helpers = require('../helpers'),
    stdMocks = require('std-mocks');

var npmTransport = new (winston.transports.Console)(),
    syslogTransport = new (winston.transports.Console)(***REMOVED*** levels: winston.config.syslog.levels ***REMOVED***),
    alignTransport = new (winston.transports.Console)(***REMOVED*** showLevel: true, align: true ***REMOVED***),
    defaultTransport = new (winston.transports.Console)(),
    rawTransport = new (winston.transports.Console)(***REMOVED*** level: 'verbose', raw: true ***REMOVED***),
    debugStdoutTransport = new (winston.transports.Console)(***REMOVED*** debugStdout: true ***REMOVED***),
    stderrLevelsTransport = new (winston.transports.Console)(***REMOVED*** stderrLevels: ['info', 'warn'] ***REMOVED***),
    customLevels = ***REMOVED***
      alpha: 0,
      beta: 1,
      gamma: 2,
      delta: 3,
      epsilon: 4,
    ***REMOVED***,
    customLevelsAndStderrTransport = new (winston.transports.Console)(***REMOVED***
      levels: customLevels,
      stderrLevels: ['delta', 'epsilon']
    ***REMOVED***),
    noStderrTransport = new (winston.transports.Console)(***REMOVED*** stderrLevels: [] ***REMOVED***);

vows.describe('winston/transports/console').addBatch(***REMOVED***
  "An instance of the Console Transport": ***REMOVED***
    "with showLevel off": ***REMOVED***
      topic : function() ***REMOVED***
        npmTransport.showLevel = false;
        stdMocks.use();
        npmTransport.log('info', 'Le message', ***REMOVED*** meta: true ***REMOVED***, this.callback);
      ***REMOVED***,
      "should not have level prepended": function () ***REMOVED***
        stdMocks.restore();
        var output = stdMocks.flush(),
            line   = output.stdout[0];

        assert.equal(line, 'Le message meta=true\n');
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  "An instance of the Console Transport": ***REMOVED***
    "with showLevel on": ***REMOVED***
      topic : function() ***REMOVED***
        npmTransport.showLevel = true;
        stdMocks.use();
        npmTransport.log('info', '');
      ***REMOVED***,
      "should have level prepended": function () ***REMOVED***
        stdMocks.restore();
        var output = stdMocks.flush(),
            line   = output.stdout[0];

        assert.equal(line, 'info: \n');
      ***REMOVED***
    ***REMOVED***,
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  "An instance of the Console Transport": ***REMOVED***
    "with npm levels": ***REMOVED***
      "should have the proper methods defined": function () ***REMOVED***
        helpers.assertConsole(npmTransport);
      ***REMOVED***,
      "the log() method": helpers.testNpmLevels(npmTransport, "should respond with true", function (ign, err, logged) ***REMOVED***
        assert.isNull(err);
        assert.isTrue(logged);
      ***REMOVED***)
    ***REMOVED***,
    "with syslog levels": ***REMOVED***
      "should have the proper methods defined": function () ***REMOVED***
        helpers.assertConsole(syslogTransport);
      ***REMOVED***,
      "the log() method": helpers.testSyslogLevels(syslogTransport, "should respond with true", function (ign, err, logged) ***REMOVED***
        assert.isNull(err);
        assert.isTrue(logged);
      ***REMOVED***)
    ***REMOVED***,
    "with end-of-line": ***REMOVED***
      topic : function() ***REMOVED***
        npmTransport.eol = 'X';
        stdMocks.use();
        npmTransport.log('info', 'Le message', ***REMOVED*** meta: true ***REMOVED***, this.callback);
      ***REMOVED***,
      "should have end-of-line character appended": function () ***REMOVED***
        stdMocks.restore();
        var output = stdMocks.flush(),
            line   = output.stdout[0];
        console.dir(line);

        assert.equal(line, 'info: Le message meta=trueX');
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  "An instance of the Console Transport with the align option on": ***REMOVED***
    topic : function() ***REMOVED***
      stdMocks.use();
      alignTransport.log('info', '');
    ***REMOVED***,
    "should have logs aligned": function () ***REMOVED***
      stdMocks.restore();
      var output = stdMocks.flush(),
          line   = output.stdout[0];

      assert.equal(line, 'info\011: \n');
    ***REMOVED***
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  "with align off": ***REMOVED***
    topic : function() ***REMOVED***
      alignTransport.align = false;
      stdMocks.use();
      alignTransport.log('info', '');
    ***REMOVED***,
    "should not have logs aligned": function () ***REMOVED***
      stdMocks.restore();
      var output = stdMocks.flush(),
          line   = output.stdout[0];

      assert.equal(line, 'info: \n');
    ***REMOVED***
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  'An instance of a raw Console transport': ***REMOVED***
    'logging to stdout': ***REMOVED***
      topic: function () ***REMOVED***
        stdMocks.use();
        rawTransport.log('verbose', 'hello there');
      ***REMOVED***, 'should output json with message property': function () ***REMOVED***
        stdMocks.restore();
        var output = stdMocks.flush();
        assert.ok(output.stdout[0].indexOf('"message":"hello there"') > -1);
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  "An instance of the Console Transport with no options": ***REMOVED***
    "should set stderrLevels to 'error' and 'debug' by default": helpers.assertStderrLevels(
      defaultTransport,
      ['error', 'debug']
    ),
    "should log only 'error' and 'debug' to stderr": helpers.testLoggingToStreams(
      winston.config.npm.levels, defaultTransport, ['debug', 'error'], stdMocks
    )
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  "An instance of the Console Transport with debugStdout set": ***REMOVED***
    "should throw an Error if stderrLevels is set": helpers.assertOptionsThrow(
      ***REMOVED*** debugStdout: true, stderrLevels: ['debug'] ***REMOVED***,
      "Error: Cannot set debugStdout and stderrLevels together"
    ),
    "should set stderrLevels to 'error' by default": helpers.assertStderrLevels(
      debugStdoutTransport,
      ['error']
    ),
    "should log only the 'error' level to stderr": helpers.testLoggingToStreams(
      winston.config.npm.levels, debugStdoutTransport, ['error'], stdMocks
    )
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  "An instance of the Console Transport with stderrLevels set": ***REMOVED***
    "should throw an Error if stderrLevels is set but not an Array": helpers.assertOptionsThrow(
      ***REMOVED*** debugStdout: false, stderrLevels: new String('Not an Array') ***REMOVED***,
      "Error: Cannot set stderrLevels to type other than Array"
    ),
    "should throw an Error if stderrLevels contains non-string elements": helpers.assertOptionsThrow(
      ***REMOVED*** debugStdout: false, stderrLevels: ["good", /^invalid$/, "valid"] ***REMOVED***,
      "Error: Cannot have non-string elements in stderrLevels Array"
    ),
    "should correctly set stderrLevels": helpers.assertStderrLevels(
      stderrLevelsTransport,
      ['info', 'warn']
    ),
    "should log only the levels in stderrLevels to stderr": helpers.testLoggingToStreams(
      winston.config.npm.levels, stderrLevelsTransport, ['info', 'warn'], stdMocks
    )
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  "An instance of the Console Transport with stderrLevels set to an empty array": ***REMOVED***
    "should log only to stdout, and not to stderr": helpers.testLoggingToStreams(
      winston.config.npm.levels, noStderrTransport, [], stdMocks
    )
  ***REMOVED***
***REMOVED***).addBatch(***REMOVED***
  "An instance of the Console Transport with custom levels and stderrLevels set": ***REMOVED***
    "should log only the levels in stderrLevels to stderr": helpers.testLoggingToStreams(
      customLevels, customLevelsAndStderrTransport, ['delta', 'epsilon'], stdMocks
    )
  ***REMOVED***
***REMOVED***).export(module);
