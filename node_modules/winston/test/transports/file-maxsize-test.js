/*
 * file-test.js: Tests for instances of the File transport
 *
 * (C) 2010 Charlie Robbins
 * MIT LICENSE
 *
 */

var assert = require('assert'),
    exec = require('child_process').exec,
    fs = require('fs'),
    path = require('path'),
    vows = require('vows'),
    winston = require('../../lib/winston'),
    helpers = require('../helpers');

var maxsizeTransport = new winston.transports.File(***REMOVED***
  timestamp: false,
  json: false,
  filename: path.join(__dirname, '..', 'fixtures', 'logs', 'testmaxsize.log'),
  maxsize: 4096
***REMOVED***);
    
vows.describe('winston/transports/file/maxsize').addBatch(***REMOVED***
  "An instance of the File Transport": ***REMOVED***
    "when passed a valid filename": ***REMOVED***
      "the log() method": ***REMOVED***
        topic: function () ***REMOVED***
          exec('rm -rf ' + path.join(__dirname, '..', 'fixtures', 'logs', 'testmaxsize*'), this.callback);
        ***REMOVED***,
        "when passed more than the maxsize": ***REMOVED***
          topic: function () ***REMOVED***
            var that = this,
                data = new Array(1018).join('-');
            
            //
            // Setup a list of files which we will later stat.
            //
            that.files = [];
            
            function logKbytes (kbytes) ***REMOVED***
              //
              // With no timestamp and at the info level,
              // winston adds exactly 7 characters: 
              // [info](4)[ :](2)[\n](1)
              //
              for (var i = 0; i < kbytes; i++) ***REMOVED***
                maxsizeTransport.log('info', data, null, function () ***REMOVED*** ***REMOVED***);
              ***REMOVED***
            ***REMOVED***
            
            maxsizeTransport.on('open', function (file) ***REMOVED***
              var match = file.match(/(\d+)\.log$/),
                  count = match ? match[1] : 0;
              
              that.files.push(file);
              
              if (that.files.length === 5) ***REMOVED***
                return that.callback();
              ***REMOVED***
              
              logKbytes(4);
            ***REMOVED***);
            
            logKbytes(4);
          ***REMOVED***,
          "should create multiple files correctly": function () ***REMOVED***
            this.files.forEach(function (file) ***REMOVED***
              try ***REMOVED***
                var stats = fs.statSync(file);
                assert.equal(stats.size, 4096);
              ***REMOVED***
              catch (ex) ***REMOVED***
                assert.isNull(ex);
              ***REMOVED***
            ***REMOVED***);
          ***REMOVED***
        ***REMOVED***
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***
***REMOVED***).export(module);