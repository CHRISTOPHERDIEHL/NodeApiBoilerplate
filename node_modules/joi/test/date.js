// Load modules

var Lab = require('lab');
var Code = require('code');
var Joi = require('../lib');
var Helper = require('./helper');


// Declare internals

var internals = ***REMOVED******REMOVED***;


// Test shortcuts

var lab = exports.lab = Lab.script();
var describe = lab.describe;
var it = lab.it;
var expect = Code.expect;


describe('date', function () ***REMOVED***

    it('fails on boolean', function (done) ***REMOVED***

        var schema = Joi.date();
        Helper.validate(schema, [
            [true, false],
            [false, false]
        ], done);
    ***REMOVED***);

    it('matches specific date', function (done) ***REMOVED***

        var now = Date.now();
        Joi.date().valid(new Date(now)).validate(new Date(now), function (err, value) ***REMOVED***

            expect(err).to.not.exist();
            done();
        ***REMOVED***);
    ***REMOVED***);

    it('errors on invalid input and convert disabled', function (done) ***REMOVED***

        Joi.date().options(***REMOVED*** convert: false ***REMOVED***).validate('1-1-2013 UTC', function (err, value) ***REMOVED***

            expect(err).to.exist();
            expect(err.message).to.equal('"value" must be a number of milliseconds or valid date string');
            done();
        ***REMOVED***);
    ***REMOVED***);

    it('validates date', function (done) ***REMOVED***

        Joi.date().validate(new Date(), function (err, value) ***REMOVED***

            expect(err).to.not.exist();
            done();
        ***REMOVED***);
    ***REMOVED***);

    it('validates millisecond date as a string', function (done) ***REMOVED***

        var now = new Date();
        var mili = now.getTime();

        Joi.date().validate(mili.toString(), function (err, value) ***REMOVED***

            expect(err).to.not.exist();
            expect(value).to.deep.equal(now);
            done();
        ***REMOVED***);
    ***REMOVED***);

    describe('#validate', function () ***REMOVED***

        describe('min', function () ***REMOVED***

            it('validates min', function (done) ***REMOVED***

                Helper.validate(Joi.date().min('1-1-2000 UTC'), [
                    ['1-1-2001 UTC', true],
                    ['1-1-2000 UTC', true],
                    [0, false],
                    ['0', false],
                    ['-1', false],
                    ['1-1-1999 UTC', false]
                ], done);
            ***REMOVED***);

            it('accepts "now" as the min date', function (done) ***REMOVED***

                var future = new Date(Date.now() + 1000000);

                Joi.date().min('now').validate(future, function (err, value) ***REMOVED***

                    expect(err).to.not.exist();
                    expect(value).to.deep.equal(future);
                    done();
                ***REMOVED***);
            ***REMOVED***);

            it('errors if .min("now") is used with a past date', function (done) ***REMOVED***

                var past = new Date(Date.now() - 1000000);

                Joi.date().min('now').validate(past, function (err, value) ***REMOVED***

                    expect(err).to.exist();
                    done();
                ***REMOVED***);
            ***REMOVED***);

            it('accepts references as min date', function (done) ***REMOVED***

                var schema = Joi.object(***REMOVED*** a: Joi.date(), b: Joi.date().min(Joi.ref('a')) ***REMOVED***);
                var now = Date.now();

                Helper.validate(schema, [
                    [***REMOVED*** a: now, b: now ***REMOVED***, true],
                    [***REMOVED*** a: now, b: now + 1e3 ***REMOVED***, true],
                    [***REMOVED*** a: now, b: now - 1e3 ***REMOVED***, false]
                ], done);
            ***REMOVED***);

            it('accepts context references as min date', function (done) ***REMOVED***

                var schema = Joi.object(***REMOVED*** b: Joi.date().min(Joi.ref('$a')) ***REMOVED***);
                var now = Date.now();

                Helper.validate(schema, [
                    [***REMOVED*** b: now ***REMOVED***, true, ***REMOVED*** context: ***REMOVED*** a: now ***REMOVED*** ***REMOVED***],
                    [***REMOVED*** b: now + 1e3 ***REMOVED***, true, ***REMOVED*** context: ***REMOVED*** a: now ***REMOVED*** ***REMOVED***],
                    [***REMOVED*** b: now - 1e3 ***REMOVED***, false, ***REMOVED*** context: ***REMOVED*** a: now ***REMOVED*** ***REMOVED***]
                ], done);
            ***REMOVED***);

            it('errors if reference is not a date', function (done) ***REMOVED***

                var schema = Joi.object(***REMOVED*** a: Joi.string(), b: Joi.date().min(Joi.ref('a')) ***REMOVED***);
                var now = Date.now();

                Helper.validate(schema, [
                    [***REMOVED*** a: 'abc', b: now ***REMOVED***, false, null, 'child "b" fails because ["b" references "a" which is not a date]'],
                    [***REMOVED*** a: '123', b: now ***REMOVED***, true],
                    [***REMOVED*** a: (now + 1e3).toString(), b: now ***REMOVED***, false, null, /^child "b" fails because \["b" must be larger than or equal to/]
                ], done);
            ***REMOVED***);

            it('errors if context reference is not a date', function (done) ***REMOVED***

                var schema = Joi.object(***REMOVED*** b: Joi.date().min(Joi.ref('$a')) ***REMOVED***);
                var now = Date.now();

                Helper.validate(schema, [
                    [***REMOVED*** b: now ***REMOVED***, false, ***REMOVED*** context: ***REMOVED*** a: 'abc' ***REMOVED*** ***REMOVED***, 'child "b" fails because ["b" references "a" which is not a date]'],
                    [***REMOVED*** b: now ***REMOVED***, false, ***REMOVED*** context: ***REMOVED*** a: (now + 1e3).toString() ***REMOVED*** ***REMOVED***, /^child "b" fails because \["b" must be larger than or equal to/]
                ], done);
            ***REMOVED***);
        ***REMOVED***);

        describe('max', function () ***REMOVED***

            it('validates max', function (done) ***REMOVED***

                Helper.validate(Joi.date().max('1-1-1970 UTC'), [
                    ['1-1-1971 UTC', false],
                    ['1-1-1970 UTC', true],
                    [0, true],
                    [1, false],
                    ['0', true],
                    ['-1', true],
                    ['1-1-2014 UTC', false]
                ], done);
            ***REMOVED***);

            it('accepts "now" as the max date', function (done) ***REMOVED***

                var past = new Date(Date.now() - 1000000);

                Joi.date().max('now').validate(past, function (err, value) ***REMOVED***

                    expect(err).to.not.exist();
                    expect(value).to.deep.equal(past);
                    done();
                ***REMOVED***);
            ***REMOVED***);

            it('errors if .max("now") is used with a future date', function (done) ***REMOVED***

                var future = new Date(Date.now() + 1000000);

                Joi.date().max('now').validate(future, function (err, value) ***REMOVED***

                    expect(err).to.exist();
                    done();
                ***REMOVED***);
            ***REMOVED***);

            it('accepts references as max date', function (done) ***REMOVED***

                var schema = Joi.object(***REMOVED*** a: Joi.date(), b: Joi.date().max(Joi.ref('a')) ***REMOVED***);
                var now = Date.now();

                Helper.validate(schema, [
                    [***REMOVED*** a: now, b: now ***REMOVED***, true],
                    [***REMOVED*** a: now, b: now + 1e3 ***REMOVED***, false],
                    [***REMOVED*** a: now, b: now - 1e3 ***REMOVED***, true]
                ], done);
            ***REMOVED***);

            it('accepts references as max date', function (done) ***REMOVED***

                var schema = Joi.object(***REMOVED*** b: Joi.date().max(Joi.ref('$a')) ***REMOVED***);
                var now = Date.now();

                Helper.validate(schema, [
                    [***REMOVED*** b: now ***REMOVED***, true, ***REMOVED*** context: ***REMOVED*** a: now ***REMOVED*** ***REMOVED***],
                    [***REMOVED*** b: now + 1e3 ***REMOVED***, false, ***REMOVED*** context: ***REMOVED*** a: now ***REMOVED*** ***REMOVED***],
                    [***REMOVED*** b: now - 1e3 ***REMOVED***, true, ***REMOVED*** context: ***REMOVED*** a: now ***REMOVED*** ***REMOVED***]
                ], done);
            ***REMOVED***);

            it('errors if reference is not a date', function (done) ***REMOVED***

                var schema = Joi.object(***REMOVED*** a: Joi.string(), b: Joi.date().max(Joi.ref('a')) ***REMOVED***);
                var now = Date.now();

                Helper.validate(schema, [
                    [***REMOVED*** a: 'abc', b: new Date() ***REMOVED***, false, null, 'child "b" fails because ["b" references "a" which is not a date]'],
                    [***REMOVED*** a: '100000000000000', b: now ***REMOVED***, true],
                    [***REMOVED*** a: (now - 1e3).toString(), b: now ***REMOVED***, false, null, /^child "b" fails because \["b" must be less than or equal to/]
                ], done);
            ***REMOVED***);

            it('errors if context reference is not a date', function (done) ***REMOVED***

                var schema = Joi.object(***REMOVED*** b: Joi.date().max(Joi.ref('$a')) ***REMOVED***);
                var now = Date.now();

                Helper.validate(schema, [
                    [***REMOVED*** b: now ***REMOVED***, false, ***REMOVED*** context: ***REMOVED*** a: 'abc' ***REMOVED*** ***REMOVED***, 'child "b" fails because ["b" references "a" which is not a date]'],
                    [***REMOVED*** b: now ***REMOVED***, true, ***REMOVED*** context: ***REMOVED*** a: '100000000000000' ***REMOVED*** ***REMOVED***],
                    [***REMOVED*** b: now ***REMOVED***, false, ***REMOVED*** context: ***REMOVED*** a: (now - 1e3).toString() ***REMOVED*** ***REMOVED***, /^child "b" fails because \["b" must be less than or equal to/]
                ], done);
            ***REMOVED***);
        ***REMOVED***);

        it('validates only valid dates', function (done) ***REMOVED***

            Helper.validate(Joi.date(), [
                ['1-1-2013 UTC', true],
                ['not a valid date', false],
                [new Date('not a valid date'), false]
            ], done);
        ***REMOVED***);

        describe('#iso', function () ***REMOVED***

            it('validates isoDate', function (done) ***REMOVED***

                Helper.validate(Joi.date().iso(), [
                    ['2013-06-07T14:21:46.295Z', true],
                    ['2013-06-07T14:21:46.295Z0', false],
                    ['2013-06-07T14:21:46.295+07:00', true],
                    ['2013-06-07T14:21:46.295+07:000', false],
                    ['2013-06-07T14:21:46.295-07:00', true],
                    ['2013-06-07T14:21:46Z', true],
                    ['2013-06-07T14:21:46Z0', false],
                    ['2013-06-07T14:21:46+07:00', true],
                    ['2013-06-07T14:21:46-07:00', true],
                    ['2013-06-07T14:21Z', true],
                    ['2013-06-07T14:21+07:00', true],
                    ['2013-06-07T14:21+07:000', false],
                    ['2013-06-07T14:21-07:00', true],
                    ['2013-06-07T14:21Z+7:00', false],
                    ['2013-06-07', true],
                    ['2013-06-07T', false],
                    ['2013-06-07T14:21', true],
                    ['1-1-2013', false]
                ], done);
            ***REMOVED***);

            it('validates isoDate with a friendly error message', function (done) ***REMOVED***

                var schema = ***REMOVED*** item: Joi.date().iso() ***REMOVED***;
                Joi.compile(schema).validate(***REMOVED*** item: 'something' ***REMOVED***, function (err, value) ***REMOVED***

                    expect(err.message).to.contain('must be a valid ISO 8601 date');
                    done();
                ***REMOVED***);
            ***REMOVED***);

            it('validates isoDate after clone', function (done) ***REMOVED***

                var schema = ***REMOVED*** item: Joi.date().iso().clone() ***REMOVED***;
                Joi.compile(schema).validate(***REMOVED*** item: '2013-06-07T14:21:46.295Z' ***REMOVED***, function (err, value) ***REMOVED***

                    expect(err).to.not.exist();
                    done();
                ***REMOVED***);
            ***REMOVED***);
        ***REMOVED***);

        describe('#format', function () ***REMOVED***

            it('validates custom format', function (done) ***REMOVED***

                Helper.validate(Joi.date().format('DD#YYYY$MM'), [
                    ['07#2013$06', true],
                    ['2013-06-07', false]
                ], done);
            ***REMOVED***);

            it('validates several custom formats', function (done) ***REMOVED***

                Helper.validate(Joi.date().format(['DD#YYYY$MM', 'YY|DD|MM']), [
                    ['13|07|06', true],
                    ['2013-06-07', false]
                ], done);
            ***REMOVED***);

            it('fails with bad formats', function (done) ***REMOVED***

                expect(function () ***REMOVED***

                    Joi.date().format(true);
                ***REMOVED***).to.throw('Invalid format.');

                expect(function () ***REMOVED***

                    Joi.date().format(['YYYYMMDD', true]);
                ***REMOVED***).to.throw('Invalid format.');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);
***REMOVED***);
