// Load modules

var Any = require('./any');
var Errors = require('./errors');
var Ref = require('./ref');
var Hoek = require('hoek');
var Moment = require('moment');


// Declare internals

var internals = ***REMOVED******REMOVED***;

internals.isoDate = /^(?:\d***REMOVED***4***REMOVED***(?!\d***REMOVED***2***REMOVED***\b))(?:(-?)(?:(?:0[1-9]|1[0-2])(?:\1(?:[12]\d|0[1-9]|3[01]))?|W(?:[0-4]\d|5[0-2])(?:-?[1-7])?|(?:00[1-9]|0[1-9]\d|[12]\d***REMOVED***2***REMOVED***|3(?:[0-5]\d|6[1-6])))(?![T]$|[T][\d]+Z$)(?:[T\s](?:(?:(?:[01]\d|2[0-3])(?:(:?)[0-5]\d)?|24\:?00)(?:[.,]\d+(?!:))?)(?:\2[0-5]\d(?:[.,]\d+)?)?(?:[Z]|(?:[+-])(?:[01]\d|2[0-3])(?::?[0-5]\d)?)?)?)?$/;
internals.invalidDate = new Date('');
internals.isIsoDate = (function () ***REMOVED***

    var isoString = internals.isoDate.toString();

    return function (date) ***REMOVED***

        return date && (date.toString() === isoString);
    ***REMOVED***;
***REMOVED***)();

internals.Date = function () ***REMOVED***

    Any.call(this);
    this._type = 'date';
***REMOVED***;

Hoek.inherits(internals.Date, Any);


internals.Date.prototype._base = function (value, state, options) ***REMOVED***

    var result = ***REMOVED***
        value: (options.convert && internals.toDate(value, this._flags.format)) || value
    ***REMOVED***;

    if (result.value instanceof Date && !isNaN(result.value.getTime())) ***REMOVED***
        result.errors = null;
    ***REMOVED***
    else ***REMOVED***
        result.errors = Errors.create(internals.isIsoDate(this._flags.format) ? 'date.isoDate' : 'date.base', null, state, options);
    ***REMOVED***

    return result;
***REMOVED***;


internals.toDate = function (value, format) ***REMOVED***

    if (value instanceof Date) ***REMOVED***
        return value;
    ***REMOVED***

    if (typeof value === 'string' ||
        Hoek.isInteger(value)) ***REMOVED***

        if (typeof value === 'string' &&
            /^[+-]?\d+$/.test(value)) ***REMOVED***

            value = parseInt(value, 10);
        ***REMOVED***

        var date;
        if (format) ***REMOVED***
            if (internals.isIsoDate(format)) ***REMOVED***
                date = format.test(value) ? new Date(value) : internals.invalidDate;
            ***REMOVED***
            else ***REMOVED***
                date = Moment(value, format, true);
                date = date.isValid() ? date.toDate() : internals.invalidDate;
            ***REMOVED***
        ***REMOVED***
        else ***REMOVED***
            date = new Date(value);
        ***REMOVED***

        if (!isNaN(date.getTime())) ***REMOVED***
            return date;
        ***REMOVED***
    ***REMOVED***

    return null;
***REMOVED***;


internals.compare = function (type, compare) ***REMOVED***

    return function (date) ***REMOVED***

        var isNow = date === 'now';
        var isRef = Ref.isRef(date);

        if (!isNow && !isRef) ***REMOVED***
            date = internals.toDate(date);
        ***REMOVED***

        Hoek.assert(date, 'Invalid date format');

        return this._test(type, date, function (value, state, options) ***REMOVED***

            var compareTo;
            if (isNow) ***REMOVED***
                compareTo = Date.now();
            ***REMOVED***
            else if (isRef) ***REMOVED***
                compareTo = internals.toDate(date(state.parent, options));

                if (!compareTo) ***REMOVED***
                    return Errors.create('date.ref', ***REMOVED*** ref: date.key ***REMOVED***, state, options);
                ***REMOVED***

                compareTo = compareTo.getTime();
            ***REMOVED***
            else ***REMOVED***
                compareTo = date.getTime();
            ***REMOVED***

            if (compare(value.getTime(), compareTo)) ***REMOVED***
                return null;
            ***REMOVED***

            return Errors.create('date.' + type, ***REMOVED*** limit: new Date(compareTo) ***REMOVED***, state, options);
        ***REMOVED***);
    ***REMOVED***;
***REMOVED***;


internals.Date.prototype.min = internals.compare('min', function (value, date) ***REMOVED***

    return value >= date;
***REMOVED***);


internals.Date.prototype.max = internals.compare('max', function (value, date) ***REMOVED***

    return value <= date;
***REMOVED***);


internals.Date.prototype.format = function (format) ***REMOVED***

    Hoek.assert(typeof format === 'string' || (Array.isArray(format) && format.every(function (f) ***REMOVED***

        return typeof f === 'string';
    ***REMOVED***)), 'Invalid format.');

    var obj = this.clone();
    obj._flags.format = format;
    return obj;
***REMOVED***;

internals.Date.prototype.iso = function () ***REMOVED***

    var obj = this.clone();
    obj._flags.format = internals.isoDate;
    return obj;
***REMOVED***;

internals.Date.prototype._isIsoDate = function (value) ***REMOVED***

    return internals.isoDate.test(value);
***REMOVED***;

module.exports = new internals.Date();
