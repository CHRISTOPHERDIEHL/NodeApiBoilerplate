
var muri = require('../')
var assert = require('assert')

describe('muri', function()***REMOVED***
  it('must begin with mongodb://', function(done)***REMOVED***
    assert.throws(function () ***REMOVED***
      muri('localhost:27017');
    ***REMOVED***, /Invalid mongodb uri/);
    assert.doesNotThrow(function () ***REMOVED***
      muri('mongodb://localhost:27017');
    ***REMOVED***)
    done();
  ***REMOVED***)

  describe('user:password', function(done)***REMOVED***
    it('is optional', function(done)***REMOVED***
      var uri = 'mongodb://local:27017';
      var val = muri(uri);
      assert.ok(!val.auth);
      done();
    ***REMOVED***)

    it('parses properly', function(done)***REMOVED***
      var uri = 'mongodb://user:password@local:27017';
      var val = muri(uri);
      assert.ok(val.auth);
      assert.equal('user', val.auth.user);
      assert.equal('password', val.auth.pass);
      done();
    ***REMOVED***)

    it('handles # in the username', function(done)***REMOVED***
      var uri = 'mongodb://us#er:password@local:27017';
      var val = muri(uri);
      assert.ok(val.auth);
      assert.equal('us#er', val.auth.user);
      assert.equal('password', val.auth.pass);
      done();
    ***REMOVED***)

    it('handles # in the password', function(done)***REMOVED***
      var uri = 'mongodb://user:pa#ssword@local:27017';
      var val = muri(uri);
      assert.ok(val.auth);
      assert.equal('user', val.auth.user);
      assert.equal('pa#ssword', val.auth.pass);
      done();
    ***REMOVED***)
  ***REMOVED***)

  describe('host', function()***REMOVED***
    it('must be specified', function(done)***REMOVED***
      assert.throws(function () ***REMOVED***
        muri('mongodb://');
      ***REMOVED***, /Missing host/)
      assert.throws(function () ***REMOVED***
        muri('mongodb:///fake');
      ***REMOVED***, /Missing host/)
      assert.throws(function () ***REMOVED***
        muri('mongodb://?yep');
      ***REMOVED***, /Missing host/)
      assert.throws(function () ***REMOVED***
        muri('mongodb:///?yep');
      ***REMOVED***, /Missing host/)

      var val = muri('mongodb://local');
      assert.ok(Array.isArray(val.hosts));
      assert.equal(1, val.hosts.length);
      assert.equal('local', val.hosts[0].host);
      done();
    ***REMOVED***)

    it('supports replica sets', function(done)***REMOVED***
      var val = muri('mongodb://local:27017,remote:27018,japan:99999');
      assert.ok(Array.isArray(val.hosts));
      assert.equal(3, val.hosts.length);
      assert.equal('local', val.hosts[0].host);
      assert.equal(27017, val.hosts[0].port);
      assert.equal('remote', val.hosts[1].host);
      assert.equal(27018, val.hosts[1].port);
      assert.equal('japan', val.hosts[2].host);
      assert.equal(99999, val.hosts[2].port);
      done();
    ***REMOVED***)
  ***REMOVED***)

  describe('port', function()***REMOVED***

    describe('with single host', function()***REMOVED***
      it('defaults to 27017 if not specified', function(done)***REMOVED***
        var val = muri('mongodb://local/');
        assert.equal(27017, val.hosts[0].port);
        done();
      ***REMOVED***)

      it('uses what is specified', function(done)***REMOVED***
        var val = muri('mongodb://local:27018');
        assert.equal(27018, val.hosts[0].port);
        done();
      ***REMOVED***)
    ***REMOVED***)

    describe('with replica sets', function()***REMOVED***
      var val;

      before(function()***REMOVED***
        val = muri('mongodb://local,remote:27018,another');
      ***REMOVED***)

      it('defaults to 27017 if not specified', function(done)***REMOVED***
        assert.equal(27017, val.hosts[0].port);
        assert.equal(27017, val.hosts[2].port);
        done();
      ***REMOVED***)

      it('uses what is specified', function(done)***REMOVED***
        assert.equal(27018, val.hosts[1].port);
        done();
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***)

  describe('database', function()***REMOVED***
    it('default', function(done)***REMOVED***
      var val = muri('mongodb://localhost/');
      assert.equal('test', val.db);
      var val = muri('mongodb://localhost');
      assert.equal('test', val.db);
      done();
    ***REMOVED***)
    it('is overridable', function(done)***REMOVED***
      var val = muri('mongodb://localhost,a,x:34343,b/muri');
      assert.equal('muri', val.db);
      done();
    ***REMOVED***)
    it('works with multiple specified protocols', function(done)***REMOVED***
      var uri = 'mongodb://localhost:27020/testing,mongodb://localhost:27019,mongodb://localhost:27018'
      var val = muri(uri);
      assert.equal('testing', val.db);
      done();
    ***REMOVED***)
  ***REMOVED***)

  describe('querystring separator', function()***REMOVED***
    it('can be ; ', function(done)***REMOVED***
      var val = muri('mongodb://muri/?replicaSet=myreplset;slaveOk=true;x=1');
      assert.ok(val.options);
      assert.equal(true, val.options.slaveOk);
      assert.equal('myreplset', val.options.replicaSet);
      assert.equal(1, val.options.x);
      done();
    ***REMOVED***)
    it('can be & ', function(done)***REMOVED***
      var val = muri('mongodb://muri/?replicaSet=myreplset&slaveOk=true&x=1');
      assert.ok(val.options);
      assert.equal(true, val.options.slaveOk);
      assert.equal('myreplset', val.options.replicaSet);
      assert.equal(1, val.options.x);
      done();
    ***REMOVED***)
  ***REMOVED***)

  describe('readPref tags', function()***REMOVED***
    describe('with & ', function()***REMOVED***
      it('mongodb://localhost/?readPreferenceTags=dc:ny', function(done)***REMOVED***
        var val = muri('mongodb://localhost/?readPreferenceTags=dc:ny');
        assert.equal('test', val.db);
        assert.deepEqual([***REMOVED*** dc: 'ny' ***REMOVED***], val.options.readPreferenceTags);
        done();
      ***REMOVED***)
      it('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1', function(done)***REMOVED***
        var val = muri('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1');
        assert.deepEqual([***REMOVED*** dc: 'ny', rack: 1 ***REMOVED***], val.options.readPreferenceTags);
        done();
      ***REMOVED***)
      it('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1&readPreferenceTags=dc:sf,rack:2', function(done)***REMOVED***
        var val = muri('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1&readPreferenceTags=dc:sf,rack:2');
        assert.deepEqual([***REMOVED*** dc: 'ny', rack: 1 ***REMOVED***, ***REMOVED*** dc: 'sf', rack: 2 ***REMOVED***], val.options.readPreferenceTags);
        done();
      ***REMOVED***)
      it('mongodb://localhost/db?readPreferenceTags=dc:ny,rack:1&readPreferenceTags=dc:sf,rack:2&readPreferenceTags=', function(done)***REMOVED***
        var val = muri('mongodb://localhost/db?readPreferenceTags=dc:ny,rack:1&readPreferenceTags=dc:sf,rack:2&readPreferenceTags=');
        assert.deepEqual([***REMOVED*** dc: 'ny', rack: 1 ***REMOVED***, ***REMOVED*** dc: 'sf', rack: 2 ***REMOVED***], val.options.readPreferenceTags);
        done();
      ***REMOVED***)
      it('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1&readPreferenceTags=dc:ny&readPreferenceTags=', function(done)***REMOVED***
        var val = muri('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1&readPreferenceTags=dc:ny&readPreferenceTags=');
        assert.deepEqual([***REMOVED*** dc: 'ny', rack: 1 ***REMOVED***, ***REMOVED*** dc: 'ny' ***REMOVED***], val.options.readPreferenceTags);
        done();
      ***REMOVED***)
    ***REMOVED***)
    describe('with ; ', function()***REMOVED***
      it('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1;readPreferenceTags=dc:sf,rack:2', function(done)***REMOVED***
        var val = muri('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1;readPreferenceTags=dc:sf,rack:2');
        assert.deepEqual([***REMOVED*** dc: 'ny', rack: 1 ***REMOVED***, ***REMOVED*** dc: 'sf', rack: 2 ***REMOVED***], val.options.readPreferenceTags);
        done();
      ***REMOVED***)
      it('mongodb://localhost/db?readPreferenceTags=dc:ny,rack:1;readPreferenceTags=dc:sf,rack:2;readPreferenceTags=', function(done)***REMOVED***
        var val = muri('mongodb://localhost/db?readPreferenceTags=dc:ny,rack:1;readPreferenceTags=dc:sf,rack:2;readPreferenceTags=');
        assert.deepEqual([***REMOVED*** dc: 'ny', rack: 1 ***REMOVED***, ***REMOVED*** dc: 'sf', rack: 2 ***REMOVED***], val.options.readPreferenceTags);
        done();
      ***REMOVED***)
      it('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1;readPreferenceTags=dc:ny;readPreferenceTags=', function(done)***REMOVED***
        var val = muri('mongodb://localhost/?readPreferenceTags=dc:ny,rack:1;readPreferenceTags=dc:ny;readPreferenceTags=');
        assert.deepEqual([***REMOVED*** dc: 'ny', rack: 1 ***REMOVED***, ***REMOVED*** dc: 'ny' ***REMOVED***], val.options.readPreferenceTags);
        done();
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***)

  describe('unix domain sockets', function()***REMOVED***
    it('without auth', function(done)***REMOVED***
      var val = muri('mongodb:///tmp/mongodb-27017.sock?safe=false');
      assert.equal(val.db, 'test')
      assert.ok(Array.isArray(val.hosts));
      assert.equal(1, val.hosts.length);
      assert.equal(val.hosts[0].ipc, '/tmp/mongodb-27017.sock')
      assert.equal(val.hosts[0].host, undefined);
      assert.equal(val.hosts[0].port, undefined);
      assert.equal(false, val.options.safe);
      done();
    ***REMOVED***)
    it('without auth with a database name', function(done)***REMOVED***
      var val = muri('mongodb:///tmp/mongodb-27017.sock/tester?safe=false');
      assert.equal(val.db, 'tester')
      assert.ok(Array.isArray(val.hosts));
      assert.equal(1, val.hosts.length);
      assert.equal(val.hosts[0].ipc, '/tmp/mongodb-27017.sock')
      assert.equal(val.hosts[0].host, undefined);
      assert.equal(val.hosts[0].port, undefined);
      assert.equal(false, val.options.safe);
      done();
    ***REMOVED***)
    it('with auth', function(done)***REMOVED***
      var val = muri('mongodb://user:password@/tmp/mongodb-27017.sock?safe=false');
      assert.equal(val.db, 'admin')
      assert.ok(Array.isArray(val.hosts));
      assert.equal(1, val.hosts.length);
      assert.equal(val.hosts[0].ipc, '/tmp/mongodb-27017.sock')
      assert.equal(val.hosts[0].host, undefined);
      assert.equal(val.hosts[0].port, undefined);
      assert.equal(false, val.options.safe);
      done();
    ***REMOVED***)
    it('with auth with a db name', function(done)***REMOVED***
      var val = muri('mongodb://user:password@/tmp/mongodb-27017.sock/tester?safe=false');
      assert.equal(val.db, 'tester')
      assert.ok(Array.isArray(val.hosts));
      assert.equal(1, val.hosts.length);
      assert.equal(val.hosts[0].ipc, '/tmp/mongodb-27017.sock')
      assert.equal(val.hosts[0].host, undefined);
      assert.equal(val.hosts[0].port, undefined);
      assert.equal(false, val.options.safe);
      done();
    ***REMOVED***)
    it('with auth + repl sets', function(done)***REMOVED***
      var val = muri('mongodb://user:password@/tmp/mongodb-27017.sock,/tmp/another-27018.sock?safe=false');
      assert.equal(val.db, 'admin')
      assert.ok(Array.isArray(val.hosts));
      assert.equal(2, val.hosts.length);
      assert.equal(val.hosts[0].ipc, '/tmp/mongodb-27017.sock')
      assert.equal(val.hosts[0].host, undefined);
      assert.equal(val.hosts[0].port, undefined);
      assert.equal(val.hosts[1].ipc, '/tmp/another-27018.sock')
      assert.equal(val.hosts[1].host, undefined);
      assert.equal(val.hosts[1].port, undefined);
      assert.equal(false, val.options.safe);
      done();
    ***REMOVED***)
    it('with auth + repl sets with a db name', function(done)***REMOVED***
      var val = muri('mongodb://user:password@/tmp/mongodb-27017.sock,/tmp/another-27018.sock/tester?safe=false');
      assert.equal(val.db, 'tester')
      assert.ok(Array.isArray(val.hosts));
      assert.equal(2, val.hosts.length);
      assert.equal(val.hosts[0].ipc, '/tmp/mongodb-27017.sock')
      assert.equal(val.hosts[0].host, undefined);
      assert.equal(val.hosts[0].port, undefined);
      assert.equal(val.hosts[1].ipc, '/tmp/another-27018.sock')
      assert.equal(val.hosts[1].host, undefined);
      assert.equal(val.hosts[1].port, undefined);
      assert.equal(false, val.options.safe);
      done();
    ***REMOVED***)
  ***REMOVED***)

  it('all together now', function(done)***REMOVED***
    var uri = 'mongodb://u#ser:pas#s@local,remote:27018,japan:27019/neatdb'
    uri +=    '?replicaSet=myreplset&journal=true&w=2&wtimeoutMS=50'
    var val = muri(uri);

    assert.equal('u#ser', val.auth.user);
    assert.equal('pas#s', val.auth.pass);
    assert.equal('neatdb', val.db);
    assert.equal(3, val.hosts.length);
    assert.equal('local', val.hosts[0].host);
    assert.strictEqual(27017, val.hosts[0].port);
    assert.equal('remote', val.hosts[1].host);
    assert.strictEqual(27018, val.hosts[1].port);
    assert.equal('japan', val.hosts[2].host);
    assert.strictEqual(27019, val.hosts[2].port);
    assert.equal('myreplset', val.options.replicaSet);
    assert.equal(true, val.options.journal);
    assert.equal(50, val.options.wtimeoutMS);
    done();
  ***REMOVED***);

  it('ipv6', function(done) ***REMOVED***
    var uri = 'mongodb://[::1]:27017/test';
    var val = muri(uri);
    assert.equal(1, val.hosts.length);
    assert.equal('::1', val.hosts[0].host);
    assert.equal(27017, val.hosts[0].port);
    done();
  ***REMOVED***);

  it('has a version', function(done)***REMOVED***
    assert.ok(muri.version);
    done();
  ***REMOVED***)

  it('replica set name with a leading number', function(done)***REMOVED***
    var uri = 'mongodb://localhost:27017/test?replicaSet=1800-shard-0';
    var val = muri(uri);
    assert.equal('1800-shard-0', val.options.replicaSet);
    done()
  ***REMOVED***)
***REMOVED***)
