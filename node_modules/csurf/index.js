/*!
 * csurf
 * Copyright(c) 2011 Sencha Inc.
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2014-2016 Douglas Christopher Wilson
 * MIT Licensed
 */

'use strict'

/**
 * Module dependencies.
 * @private
 */

var Cookie = require('cookie')
var createError = require('http-errors')
var sign = require('cookie-signature').sign
var Tokens = require('csrf')

/**
 * Module exports.
 * @public
 */

module.exports = csurf

/**
 * CSRF protection middleware.
 *
 * This middleware adds a `req.csrfToken()` function to make a token
 * which should be added to requests which mutate
 * state, within a hidden form field, query-string etc. This
 * token is validated against the visitor's session.
 *
 * @param ***REMOVED***Object***REMOVED*** options
 * @return ***REMOVED***Function***REMOVED*** middleware
 * @public
 */

function csurf (options) ***REMOVED***
  var opts = options || ***REMOVED******REMOVED***

  // get cookie options
  var cookie = getCookieOptions(opts.cookie)

  // get session options
  var sessionKey = opts.sessionKey || 'session'

  // get value getter
  var value = opts.value || defaultValue

  // token repo
  var tokens = new Tokens(opts)

  // ignored methods
  var ignoreMethods = opts.ignoreMethods === undefined
    ? ['GET', 'HEAD', 'OPTIONS']
    : opts.ignoreMethods

  if (!Array.isArray(ignoreMethods)) ***REMOVED***
    throw new TypeError('option ignoreMethods must be an array')
  ***REMOVED***

  // generate lookup
  var ignoreMethod = getIgnoredMethods(ignoreMethods)

  return function csrf (req, res, next) ***REMOVED***
    // validate the configuration against request
    if (!verifyConfiguration(req, sessionKey, cookie)) ***REMOVED***
      return next(new Error('misconfigured csrf'))
    ***REMOVED***

    // get the secret from the request
    var secret = getSecret(req, sessionKey, cookie)
    var token

    // lazy-load token getter
    req.csrfToken = function csrfToken () ***REMOVED***
      var sec = !cookie
        ? getSecret(req, sessionKey, cookie)
        : secret

      // use cached token if secret has not changed
      if (token && sec === secret) ***REMOVED***
        return token
      ***REMOVED***

      // generate & set new secret
      if (sec === undefined) ***REMOVED***
        sec = tokens.secretSync()
        setSecret(req, res, sessionKey, sec, cookie)
      ***REMOVED***

      // update changed secret
      secret = sec

      // create new token
      token = tokens.create(secret)

      return token
    ***REMOVED***

    // generate & set secret
    if (!secret) ***REMOVED***
      secret = tokens.secretSync()
      setSecret(req, res, sessionKey, secret, cookie)
    ***REMOVED***

    // verify the incoming token
    if (!ignoreMethod[req.method] && !tokens.verify(secret, value(req))) ***REMOVED***
      return next(createError(403, 'invalid csrf token', ***REMOVED***
        code: 'EBADCSRFTOKEN'
      ***REMOVED***))
    ***REMOVED***

    next()
  ***REMOVED***
***REMOVED***

/**
 * Default value function, checking the `req.body`
 * and `req.query` for the CSRF token.
 *
 * @param ***REMOVED***IncomingMessage***REMOVED*** req
 * @return ***REMOVED***String***REMOVED***
 * @api private
 */

function defaultValue (req) ***REMOVED***
  return (req.body && req.body._csrf) ||
    (req.query && req.query._csrf) ||
    (req.headers['csrf-token']) ||
    (req.headers['xsrf-token']) ||
    (req.headers['x-csrf-token']) ||
    (req.headers['x-xsrf-token'])
***REMOVED***

/**
 * Get options for cookie.
 *
 * @param ***REMOVED***boolean|object***REMOVED*** [options]
 * @returns ***REMOVED***object***REMOVED***
 * @api private
 */

function getCookieOptions (options) ***REMOVED***
  if (options !== true && typeof options !== 'object') ***REMOVED***
    return undefined
  ***REMOVED***

  var opts = ***REMOVED***
    key: '_csrf',
    path: '/'
  ***REMOVED***

  if (options && typeof options === 'object') ***REMOVED***
    for (var prop in options) ***REMOVED***
      var val = options[prop]

      if (val !== undefined) ***REMOVED***
        opts[prop] = val
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***

  return opts
***REMOVED***

/**
 * Get a lookup of ignored methods.
 *
 * @param ***REMOVED***array***REMOVED*** methods
 * @returns ***REMOVED***object***REMOVED***
 * @api private
 */

function getIgnoredMethods (methods) ***REMOVED***
  var obj = Object.create(null)

  for (var i = 0; i < methods.length; i++) ***REMOVED***
    var method = methods[i].toUpperCase()
    obj[method] = true
  ***REMOVED***

  return obj
***REMOVED***

/**
 * Get the token secret from the request.
 *
 * @param ***REMOVED***IncomingMessage***REMOVED*** req
 * @param ***REMOVED***String***REMOVED*** sessionKey
 * @param ***REMOVED***Object***REMOVED*** [cookie]
 * @api private
 */

function getSecret (req, sessionKey, cookie) ***REMOVED***
  // get the bag & key
  var bag = getSecretBag(req, sessionKey, cookie)
  var key = cookie ? cookie.key : 'csrfSecret'

  if (!bag) ***REMOVED***
    /* istanbul ignore next: should never actually run */
    throw new Error('misconfigured csrf')
  ***REMOVED***

  // return secret from bag
  return bag[key]
***REMOVED***

/**
 * Get the token secret bag from the request.
 *
 * @param ***REMOVED***IncomingMessage***REMOVED*** req
 * @param ***REMOVED***String***REMOVED*** sessionKey
 * @param ***REMOVED***Object***REMOVED*** [cookie]
 * @api private
 */

function getSecretBag (req, sessionKey, cookie) ***REMOVED***
  if (cookie) ***REMOVED***
    // get secret from cookie
    var cookieKey = cookie.signed
      ? 'signedCookies'
      : 'cookies'

    return req[cookieKey]
  ***REMOVED*** else ***REMOVED***
    // get secret from session
    return req[sessionKey]
  ***REMOVED***
***REMOVED***

/**
 * Set a cookie on the HTTP response.
 *
 * @param ***REMOVED***OutgoingMessage***REMOVED*** res
 * @param ***REMOVED***string***REMOVED*** name
 * @param ***REMOVED***string***REMOVED*** val
 * @param ***REMOVED***Object***REMOVED*** [options]
 * @api private
 */

function setCookie (res, name, val, options) ***REMOVED***
  var data = Cookie.serialize(name, val, options)

  var prev = res.getHeader('set-cookie') || []
  var header = Array.isArray(prev) ? prev.concat(data)
    : Array.isArray(data) ? [prev].concat(data)
    : [prev, data]

  res.setHeader('set-cookie', header)
***REMOVED***

/**
 * Set the token secret on the request.
 *
 * @param ***REMOVED***IncomingMessage***REMOVED*** req
 * @param ***REMOVED***OutgoingMessage***REMOVED*** res
 * @param ***REMOVED***string***REMOVED*** sessionKey
 * @param ***REMOVED***string***REMOVED*** val
 * @param ***REMOVED***Object***REMOVED*** [cookie]
 * @api private
 */

function setSecret (req, res, sessionKey, val, cookie) ***REMOVED***
  if (cookie) ***REMOVED***
    // set secret on cookie
    if (cookie.signed) ***REMOVED***
      var secret = req.secret

      if (!secret) ***REMOVED***
        /* istanbul ignore next: should never actually run */
        throw new Error('misconfigured csrf')
      ***REMOVED***

      val = 's:' + sign(val, secret)
    ***REMOVED***

    setCookie(res, cookie.key, val, cookie)
  ***REMOVED*** else if (req[sessionKey]) ***REMOVED***
    // set secret on session
    req[sessionKey].csrfSecret = val
  ***REMOVED*** else ***REMOVED***
    /* istanbul ignore next: should never actually run */
    throw new Error('misconfigured csrf')
  ***REMOVED***
***REMOVED***

/**
 * Verify the configuration against the request.
 * @private
 */

function verifyConfiguration (req, sessionKey, cookie) ***REMOVED***
  if (!getSecretBag(req, sessionKey, cookie)) ***REMOVED***
    return false
  ***REMOVED***

  if (cookie && cookie.signed && !req.secret) ***REMOVED***
    return false
  ***REMOVED***

  return true
***REMOVED***
