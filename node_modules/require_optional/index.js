var path = require('path'),
  fs = require('fs'),
  f = require('util').format,
  resolveFrom = require('resolve-from'),
  semver = require('semver');

var exists = fs.existsSync || path.existsSync;

var find_package_json = function(location) ***REMOVED***
  var found = false;

  while(!found) ***REMOVED***
    if (exists(location + '/package.json')) ***REMOVED***
      found = location;
    ***REMOVED*** else if (location !== '/') ***REMOVED***
      location = path.dirname(location);
    ***REMOVED*** else ***REMOVED***
      return false;
    ***REMOVED***
  ***REMOVED***

  return location;
***REMOVED***

var require_optional = function(name, options) ***REMOVED***
  options = options || ***REMOVED******REMOVED***;
  options.strict = typeof options.strict == 'boolean' ? options.strict : true;

  // Current location
  var location = __dirname;
  // Check if we have a parent
  if(module.parent) ***REMOVED***
    location = module.parent.filename;
  ***REMOVED***

  // Locate this module's package.json file
  var location = find_package_json(location);
  if(!location) ***REMOVED***
    throw new Error('package.json can not be located');
  ***REMOVED***

  // Read the package.json file
  var object = JSON.parse(fs.readFileSync(f('%s/package.json', location)));
  // Is the name defined by interal file references
  var parts = name.split(/\//);

  // Optional dependencies exist
  if(!object.peerOptionalDependencies) ***REMOVED***
    throw new Error(f('no optional dependency [%s] defined in peerOptionalDependencies in package.json', parts[0]));
  ***REMOVED*** else if(object.peerOptionalDependencies && !object.peerOptionalDependencies[parts[0]]) ***REMOVED***
    throw new Error(f('no optional dependency [%s] defined in peerOptionalDependencies in package.json', parts[0]));
  ***REMOVED***

  // Unpack the expected version
  var expectedVersions = object.peerOptionalDependencies[parts[0]];
  // The resolved package
  var moduleEntry = undefined;
  // Module file
  var moduleEntryFile = name;

  try ***REMOVED***
    // Validate if it's possible to read the module
    moduleEntry = require(moduleEntryFile);
  ***REMOVED*** catch(err) ***REMOVED***
    // Attempt to resolve in top level package
    try ***REMOVED***
      // Get the module entry file
      moduleEntryFile = resolveFrom(process.cwd(), name);
      if(moduleEntryFile == null) return undefined;
      // Attempt to resolve the module
      moduleEntry = require(moduleEntryFile);
    ***REMOVED*** catch(err) ***REMOVED***
      if(err.code === 'MODULE_NOT_FOUND') return undefined;
    ***REMOVED***
  ***REMOVED***

  // Resolve the location of the module's package.json file
  var location = find_package_json(require.resolve(moduleEntryFile));
  if(!location) ***REMOVED***
    throw new Error('package.json can not be located');
  ***REMOVED***

  // Read the module file
  var dependentOnModule = JSON.parse(fs.readFileSync(f('%s/package.json', location)));
  // Get the version
  var version = dependentOnModule.version;
  // Validate if the found module satisfies the version id
  if(semver.satisfies(version, expectedVersions) == false
    && options.strict) ***REMOVED***
      var error = new Error(f('optional dependency [%s] found but version [%s] did not satisfy constraint [%s]', parts[0], version, expectedVersions));
      error.code = 'OPTIONAL_MODULE_NOT_FOUND';
      throw error;
  ***REMOVED***

  // Satifies the module requirement
  return moduleEntry;
***REMOVED***

require_optional.exists = function(name) ***REMOVED***
  try ***REMOVED***
    var m = require_optional(name);
    if(m === undefined) return false;
    return true;
  ***REMOVED*** catch(err) ***REMOVED***
    return false;
  ***REMOVED***
***REMOVED***

module.exports = require_optional;
