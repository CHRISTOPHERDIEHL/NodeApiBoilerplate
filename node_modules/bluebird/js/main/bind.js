"use strict";
module.exports = function(Promise, INTERNAL, tryConvertToPromise) ***REMOVED***
var rejectThis = function(_, e) ***REMOVED***
    this._reject(e);
***REMOVED***;

var targetRejected = function(e, context) ***REMOVED***
    context.promiseRejectionQueued = true;
    context.bindingPromise._then(rejectThis, rejectThis, null, this, e);
***REMOVED***;

var bindingResolved = function(thisArg, context) ***REMOVED***
    if (this._isPending()) ***REMOVED***
        this._resolveCallback(context.target);
    ***REMOVED***
***REMOVED***;

var bindingRejected = function(e, context) ***REMOVED***
    if (!context.promiseRejectionQueued) this._reject(e);
***REMOVED***;

Promise.prototype.bind = function (thisArg) ***REMOVED***
    var maybePromise = tryConvertToPromise(thisArg);
    var ret = new Promise(INTERNAL);
    ret._propagateFrom(this, 1);
    var target = this._target();

    ret._setBoundTo(maybePromise);
    if (maybePromise instanceof Promise) ***REMOVED***
        var context = ***REMOVED***
            promiseRejectionQueued: false,
            promise: ret,
            target: target,
            bindingPromise: maybePromise
        ***REMOVED***;
        target._then(INTERNAL, targetRejected, ret._progress, ret, context);
        maybePromise._then(
            bindingResolved, bindingRejected, ret._progress, ret, context);
    ***REMOVED*** else ***REMOVED***
        ret._resolveCallback(target);
    ***REMOVED***
    return ret;
***REMOVED***;

Promise.prototype._setBoundTo = function (obj) ***REMOVED***
    if (obj !== undefined) ***REMOVED***
        this._bitField = this._bitField | 131072;
        this._boundTo = obj;
    ***REMOVED*** else ***REMOVED***
        this._bitField = this._bitField & (~131072);
    ***REMOVED***
***REMOVED***;

Promise.prototype._isBound = function () ***REMOVED***
    return (this._bitField & 131072) === 131072;
***REMOVED***;

Promise.bind = function (thisArg, value) ***REMOVED***
    var maybePromise = tryConvertToPromise(thisArg);
    var ret = new Promise(INTERNAL);

    ret._setBoundTo(maybePromise);
    if (maybePromise instanceof Promise) ***REMOVED***
        maybePromise._then(function() ***REMOVED***
            ret._resolveCallback(value);
        ***REMOVED***, ret._reject, ret._progress, ret, null);
    ***REMOVED*** else ***REMOVED***
        ret._resolveCallback(value);
    ***REMOVED***
    return ret;
***REMOVED***;
***REMOVED***;
