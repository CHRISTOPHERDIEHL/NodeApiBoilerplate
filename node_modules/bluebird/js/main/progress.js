"use strict";
module.exports = function(Promise, PromiseArray) ***REMOVED***
var util = require("./util.js");
var async = require("./async.js");
var tryCatch = util.tryCatch;
var errorObj = util.errorObj;

Promise.prototype.progressed = function (handler) ***REMOVED***
    return this._then(undefined, undefined, handler, undefined, undefined);
***REMOVED***;

Promise.prototype._progress = function (progressValue) ***REMOVED***
    if (this._isFollowingOrFulfilledOrRejected()) return;
    this._target()._progressUnchecked(progressValue);

***REMOVED***;

Promise.prototype._progressHandlerAt = function (index) ***REMOVED***
    return index === 0
        ? this._progressHandler0
        : this[(index << 2) + index - 5 + 2];
***REMOVED***;

Promise.prototype._doProgressWith = function (progression) ***REMOVED***
    var progressValue = progression.value;
    var handler = progression.handler;
    var promise = progression.promise;
    var receiver = progression.receiver;

    var ret = tryCatch(handler).call(receiver, progressValue);
    if (ret === errorObj) ***REMOVED***
        if (ret.e != null &&
            ret.e.name !== "StopProgressPropagation") ***REMOVED***
            var trace = util.canAttachTrace(ret.e)
                ? ret.e : new Error(util.toString(ret.e));
            promise._attachExtraTrace(trace);
            promise._progress(ret.e);
        ***REMOVED***
    ***REMOVED*** else if (ret instanceof Promise) ***REMOVED***
        ret._then(promise._progress, null, null, promise, undefined);
    ***REMOVED*** else ***REMOVED***
        promise._progress(ret);
    ***REMOVED***
***REMOVED***;


Promise.prototype._progressUnchecked = function (progressValue) ***REMOVED***
    var len = this._length();
    var progress = this._progress;
    for (var i = 0; i < len; i++) ***REMOVED***
        var handler = this._progressHandlerAt(i);
        var promise = this._promiseAt(i);
        if (!(promise instanceof Promise)) ***REMOVED***
            var receiver = this._receiverAt(i);
            if (typeof handler === "function") ***REMOVED***
                handler.call(receiver, progressValue, promise);
            ***REMOVED*** else if (receiver instanceof PromiseArray &&
                       !receiver._isResolved()) ***REMOVED***
                receiver._promiseProgressed(progressValue, promise);
            ***REMOVED***
            continue;
        ***REMOVED***

        if (typeof handler === "function") ***REMOVED***
            async.invoke(this._doProgressWith, this, ***REMOVED***
                handler: handler,
                promise: promise,
                receiver: this._receiverAt(i),
                value: progressValue
            ***REMOVED***);
        ***REMOVED*** else ***REMOVED***
            async.invoke(progress, promise, progressValue);
        ***REMOVED***
    ***REMOVED***
***REMOVED***;
***REMOVED***;
