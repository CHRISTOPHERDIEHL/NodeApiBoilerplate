"use strict";
module.exports = function(Promise,
                          apiRejection,
                          INTERNAL,
                          tryConvertToPromise) ***REMOVED***
var errors = require("./errors.js");
var TypeError = errors.TypeError;
var util = require("./util.js");
var errorObj = util.errorObj;
var tryCatch = util.tryCatch;
var yieldHandlers = [];

function promiseFromYieldHandler(value, yieldHandlers, traceParent) ***REMOVED***
    for (var i = 0; i < yieldHandlers.length; ++i) ***REMOVED***
        traceParent._pushContext();
        var result = tryCatch(yieldHandlers[i])(value);
        traceParent._popContext();
        if (result === errorObj) ***REMOVED***
            traceParent._pushContext();
            var ret = Promise.reject(errorObj.e);
            traceParent._popContext();
            return ret;
        ***REMOVED***
        var maybePromise = tryConvertToPromise(result, traceParent);
        if (maybePromise instanceof Promise) return maybePromise;
    ***REMOVED***
    return null;
***REMOVED***

function PromiseSpawn(generatorFunction, receiver, yieldHandler, stack) ***REMOVED***
    var promise = this._promise = new Promise(INTERNAL);
    promise._captureStackTrace();
    this._stack = stack;
    this._generatorFunction = generatorFunction;
    this._receiver = receiver;
    this._generator = undefined;
    this._yieldHandlers = typeof yieldHandler === "function"
        ? [yieldHandler].concat(yieldHandlers)
        : yieldHandlers;
***REMOVED***

PromiseSpawn.prototype.promise = function () ***REMOVED***
    return this._promise;
***REMOVED***;

PromiseSpawn.prototype._run = function () ***REMOVED***
    this._generator = this._generatorFunction.call(this._receiver);
    this._receiver =
        this._generatorFunction = undefined;
    this._next(undefined);
***REMOVED***;

PromiseSpawn.prototype._continue = function (result) ***REMOVED***
    if (result === errorObj) ***REMOVED***
        return this._promise._rejectCallback(result.e, false, true);
    ***REMOVED***

    var value = result.value;
    if (result.done === true) ***REMOVED***
        this._promise._resolveCallback(value);
    ***REMOVED*** else ***REMOVED***
        var maybePromise = tryConvertToPromise(value, this._promise);
        if (!(maybePromise instanceof Promise)) ***REMOVED***
            maybePromise =
                promiseFromYieldHandler(maybePromise,
                                        this._yieldHandlers,
                                        this._promise);
            if (maybePromise === null) ***REMOVED***
                this._throw(
                    new TypeError(
                        "A value %s was yielded that could not be treated as a promise\u000a\u000a    See http://goo.gl/4Y4pDk\u000a\u000a".replace("%s", value) +
                        "From coroutine:\u000a" +
                        this._stack.split("\n").slice(1, -7).join("\n")
                    )
                );
                return;
            ***REMOVED***
        ***REMOVED***
        maybePromise._then(
            this._next,
            this._throw,
            undefined,
            this,
            null
       );
    ***REMOVED***
***REMOVED***;

PromiseSpawn.prototype._throw = function (reason) ***REMOVED***
    this._promise._attachExtraTrace(reason);
    this._promise._pushContext();
    var result = tryCatch(this._generator["throw"])
        .call(this._generator, reason);
    this._promise._popContext();
    this._continue(result);
***REMOVED***;

PromiseSpawn.prototype._next = function (value) ***REMOVED***
    this._promise._pushContext();
    var result = tryCatch(this._generator.next).call(this._generator, value);
    this._promise._popContext();
    this._continue(result);
***REMOVED***;

Promise.coroutine = function (generatorFunction, options) ***REMOVED***
    if (typeof generatorFunction !== "function") ***REMOVED***
        throw new TypeError("generatorFunction must be a function\u000a\u000a    See http://goo.gl/6Vqhm0\u000a");
    ***REMOVED***
    var yieldHandler = Object(options).yieldHandler;
    var PromiseSpawn$ = PromiseSpawn;
    var stack = new Error().stack;
    return function () ***REMOVED***
        var generator = generatorFunction.apply(this, arguments);
        var spawn = new PromiseSpawn$(undefined, undefined, yieldHandler,
                                      stack);
        spawn._generator = generator;
        spawn._next(undefined);
        return spawn.promise();
    ***REMOVED***;
***REMOVED***;

Promise.coroutine.addYieldHandler = function(fn) ***REMOVED***
    if (typeof fn !== "function") throw new TypeError("fn must be a function\u000a\u000a    See http://goo.gl/916lJJ\u000a");
    yieldHandlers.push(fn);
***REMOVED***;

Promise.spawn = function (generatorFunction) ***REMOVED***
    if (typeof generatorFunction !== "function") ***REMOVED***
        return apiRejection("generatorFunction must be a function\u000a\u000a    See http://goo.gl/6Vqhm0\u000a");
    ***REMOVED***
    var spawn = new PromiseSpawn(generatorFunction, this);
    var ret = spawn.promise();
    spawn._run(Promise.spawn);
    return ret;
***REMOVED***;
***REMOVED***;
