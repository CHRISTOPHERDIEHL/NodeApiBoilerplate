var extract_jwt = require('../lib/extract_jwt'),
    Request = require('./mock_request');

describe('Token extractor', function() ***REMOVED***

    describe('fromHeader', function() ***REMOVED***

        var extractor = extract_jwt.fromHeader('test_header');

        it('should return null no when token is present', function() ***REMOVED***
            var req = new Request();

            var token = extractor(req);

            expect(token).to.be.null; 
        ***REMOVED***);


        it('should return the value from the specified header', function() ***REMOVED***
            var req = new Request();
            req.headers['test_header'] = 'abcd123'

            var token = extractor(req)

            expect(token).to.equal('abcd123'); 
        ***REMOVED***);
    ***REMOVED***);


    describe('fromBodyField', function() ***REMOVED***

        var extractor = extract_jwt.fromBodyField('test_field');

        it('should return null when no body is present', function() ***REMOVED***
            var req = new Request();
            
            var token = extractor(req);

            expect(token).to.be.null;
        ***REMOVED***);


        it('should return null when the specified body field is not present', function() ***REMOVED***
            var req = new Request();
            req.body = ***REMOVED******REMOVED***;

            var token = extractor(req);

            expect(token).to.be.null;
        ***REMOVED***);


        it('should return the value from the specified body field', function() ***REMOVED***
            var req = new Request();
            req.body = ***REMOVED******REMOVED***;
            req.body.test_field = 'abcd123';

            var token = extractor(req);

            expect(token).to.equal('abcd123');
        ***REMOVED***);


        it('should work properly with querystring', function() ***REMOVED***
            var req = new Request();
            const querystring = require('querystring');
            req.body = querystring.parse('test_field=abcd123')

            var token = extractor(req);

            expect(token).to.equal('abcd123')
        ***REMOVED***);
    ***REMOVED***);


    describe('fromUrlQueryParameter', function() ***REMOVED***

        var extractor = extract_jwt.fromUrlQueryParameter('test_param');


        it('should return null when the specified paramter is not present', function() ***REMOVED***
            var req = new Request();

            var token = extractor(req);

            expect(token).to.be.null;
        ***REMOVED***);


        it('should return the value from the specified parameter', function() ***REMOVED***
            var req = new Request();
            req.url += '?test_param=abcd123';

            var token = extractor(req);

            expect(token).to.equal('abcd123');
        ***REMOVED***);
    ***REMOVED***);


    describe('fromAuthHeaderWithScheme', function() ***REMOVED***

        var extractor = extract_jwt.fromAuthHeaderWithScheme('TEST_SCHEME');

        it('should return null when no auth header is present', function() ***REMOVED***
            var req = new Request();

            var token = extractor(req);

            expect(token).to.be.null;
        ***REMOVED***);


        it('should return null when the auth header is present but the auth scheme doesnt match', function() ***REMOVED***
            var req = new Request()
            req.headers['authorization'] = "NOT_TEST_SCHEME abcd123";

            var token = extractor(req);

            expect(token).to.be.null;
        ***REMOVED***);


        it('should return the value from the authorization header with specified auth scheme', function() ***REMOVED***
            var req = new Request()
            req.headers['authorization'] = "TEST_SCHEME abcd123";

            var token = extractor(req);

            expect(token).to.equal('abcd123');
        ***REMOVED***);

    ***REMOVED***);


    describe('fromAuthHeader', function() ***REMOVED***
        
        var extractor = extract_jwt.fromAuthHeader();

        it('should return the value from the authorization header with default JWT auth scheme', function() ***REMOVED***
            var req = new Request()
            req.headers['authorization'] = "JWT abcd123";

            var token = extractor(req);

            expect(token).to.equal('abcd123');
        ***REMOVED***);


    ***REMOVED***);
    
    describe('fromExtractors', function() ***REMOVED***

        it('should raise a type error when the extractor is constructed with a non-array argument', function() ***REMOVED***
            this_should_throw = function() ***REMOVED***
                var extractor = extract_jwt.fromExtractors(***REMOVED******REMOVED***)
            ***REMOVED***

            expect(this_should_throw).to.throw(TypeError)
        ***REMOVED***);


        var extractor = extract_jwt.fromExtractors([extract_jwt.fromAuthHeader(), extract_jwt.fromHeader('authorization')]);

        it('should return null when no extractor extracts token', function() ***REMOVED***
            var req = new Request();

            var token = extractor(req);

            expect(token).to.be.null;
        ***REMOVED***);


        it('should return token found by least extractor', function() ***REMOVED***
            var req = new Request()
            req.headers['authorization'] = "abcd123";

            var token = extractor(req);

            expect(token).to.equal('abcd123');
        ***REMOVED***);


        it('should return token found by first extractor', function() ***REMOVED***
            var req = new Request()
            req.headers['authorization'] = "JWT abcd123";

            var token = extractor(req);

            expect(token).to.equal('abcd123');
        ***REMOVED***);

    ***REMOVED***);


    describe('versionOneCompatibility', function () ***REMOVED***

        describe('default behavior', function() ***REMOVED***

                var extractor = extract_jwt.versionOneCompatibility(***REMOVED******REMOVED***);

                it('should return the token in the default "JWT" auth header', function () ***REMOVED***
                    var req = new Request();
                    req.headers['authorization'] = "JWT abcd123";

                    var token = extractor(req);

                    expect(token).to.equal('abcd123');
                ***REMOVED***);


                it('should return the token in the default "auth_token" body field', function () ***REMOVED***
                    var req = new Request();
                    req.body = ***REMOVED******REMOVED***;
                    req.body['auth_token'] = 'xyzabcd';

                    var token = extractor(req);

                    expect(token).to.equal('xyzabcd');
                ***REMOVED***);


                it('should return then token in the default "auth_token" query parameter', function () ***REMOVED***
                    var req = new Request();
                    req.url += '?auth_token=abcd123';

                    var token = extractor(req);

                    expect(token).to.equal('abcd123');
                ***REMOVED***);
        ***REMOVED***);


        describe('user supplied parameters', function() ***REMOVED***

            it('should return the token in an auth header with a user specified auth scheme', function() ***REMOVED***
                var opts = ***REMOVED*** authScheme: 'MY_CUSTOM_AUTH_SCHEME' ***REMOVED***;
                var extractor = extract_jwt.versionOneCompatibility(opts);
                var req = new Request();
                req.headers['authorization'] = 'MY_CUSTOM_AUTH_SCHEME deadbeef';

                var token = extractor(req);

                expect(token).to.equal('deadbeef');
            ***REMOVED***);


            it('should return the token in a user supplied body field', function () ***REMOVED***
                var opts = ***REMOVED*** tokenBodyField: 'CUSTOM_BODY_FIELD' ***REMOVED***;
                var extractor = extract_jwt.versionOneCompatibility(opts);
                var req = new Request();
                req.body = ***REMOVED******REMOVED***;
                req.body['CUSTOM_BODY_FIELD'] = 'badbeef';

                var token = extractor(req);

                expect(token).to.equal('badbeef');
            ***REMOVED***);


            it('should return the token in a user specified query parameter', function () ***REMOVED***
                var opts = ***REMOVED*** tokenQueryParameterName: 'CustomQueryParam' ***REMOVED***;
                var extractor = extract_jwt.versionOneCompatibility(opts);
                var req = new Request();
                req.url += '?CustomQueryParam=deadbeef';

                var token = extractor(req);

                expect(token).to.equal('deadbeef');
            ***REMOVED***);

        ***REMOVED***);


    ***REMOVED***);

***REMOVED***);

