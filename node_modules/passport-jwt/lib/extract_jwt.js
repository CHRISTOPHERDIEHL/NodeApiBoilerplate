"use strict";

var url = require('url'),
    auth_hdr = require('./auth_header');

// Note: express http converts all headers
// to lower case.
var AUTH_HEADER = "authorization",
    DEFAULT_AUTH_SCHEME = "JWT";


var extractors = ***REMOVED******REMOVED***;


extractors.fromHeader = function (header_name) ***REMOVED***
    return function (request) ***REMOVED***
        var token = null;
        if (request.headers[header_name]) ***REMOVED***
            token = request.headers[header_name];
        ***REMOVED***
        return token;
    ***REMOVED***;
***REMOVED***;



extractors.fromBodyField = function (field_name) ***REMOVED***
    return function (request) ***REMOVED***
        var token = null;
        if (request.body && Object.prototype.hasOwnProperty.call(request.body, field_name)) ***REMOVED***
            token = request.body[field_name];
        ***REMOVED***
        return token;
    ***REMOVED***;
***REMOVED***;



extractors.fromUrlQueryParameter = function (param_name) ***REMOVED***
    return function (request) ***REMOVED***
        var token = null,
            parsed_url = url.parse(request.url, true);
        if (parsed_url.query && Object.prototype.hasOwnProperty.call(parsed_url.query, param_name)) ***REMOVED***
            token = parsed_url.query[param_name];
        ***REMOVED***
        return token;
    ***REMOVED***;
***REMOVED***;



extractors.fromAuthHeaderWithScheme = function (auth_scheme) ***REMOVED***
    return function (request) ***REMOVED***

        var token = null;
        if (request.headers[AUTH_HEADER]) ***REMOVED***
            var auth_params = auth_hdr.parse(request.headers[AUTH_HEADER]);
            if (auth_params && auth_scheme === auth_params.scheme) ***REMOVED***
                token = auth_params.value;
            ***REMOVED***
        ***REMOVED***
        return token;
    ***REMOVED***;
***REMOVED***;



extractors.fromAuthHeader = function () ***REMOVED***
    return extractors.fromAuthHeaderWithScheme(DEFAULT_AUTH_SCHEME);
***REMOVED***;


extractors.fromExtractors = function(extractors) ***REMOVED***
    if (!Array.isArray(extractors)) ***REMOVED***
        throw new TypeError('extractors.fromExtractors expects an array')
    ***REMOVED***
    
    return function (request) ***REMOVED***
        var token = null;
        var index = 0;
        while(!token && index < extractors.length) ***REMOVED***
            token = extractors[index].call(this, request);
            index ++;
        ***REMOVED***
        return token;
    ***REMOVED***
***REMOVED***;


/**
 * This extractor mimics the behavior of the v1.*.* extraction logic.
 *
 * This extractor exists only to provide an easy transition from the v1.*.* API to the v2.0.0
 * API.
 *
 * This extractor first checks the auth header, if it doesn't find a token there then it checks the 
 * specified body field and finally the url query parameters.
 * 
 * @param options
 *          authScheme: Expected scheme when JWT can be found in HTTP Authorize header. Default is JWT. 
 *          tokenBodyField: Field in request body containing token. Default is auth_token.
 *          tokenQueryParameterName: Query parameter name containing the token. Default is auth_token.
 */
extractors.versionOneCompatibility = function (options) ***REMOVED***
    var authScheme = options.authScheme || DEFAULT_AUTH_SCHEME,
        bodyField = options.tokenBodyField || 'auth_token',
        queryParam = options.tokenQueryParameterName || 'auth_token';

    return function (request) ***REMOVED***
        var authHeaderExtractor = extractors.fromAuthHeaderWithScheme(authScheme);
        var token =  authHeaderExtractor(request);
        
        if (!token) ***REMOVED***
            var bodyExtractor = extractors.fromBodyField(bodyField);
            token = bodyExtractor(request);
        ***REMOVED***

        if (!token) ***REMOVED***
            var queryExtractor = extractors.fromUrlQueryParameter(queryParam);
            token = queryExtractor(request);
        ***REMOVED***

        return token;
    ***REMOVED***;
***REMOVED***



/**
 * Export the Jwt extraction functions
 */
module.exports = extractors;
