/**
 * Module dependencies.
 */
var pause = require('pause')
  , util = require('util')
  , Strategy = require('passport-strategy');


/**
 * `SessionStrategy` constructor.
 *
 * @api public
 */
function SessionStrategy() ***REMOVED***
  Strategy.call(this);
  this.name = 'session';
***REMOVED***

/**
 * Inherit from `Strategy`.
 */
util.inherits(SessionStrategy, Strategy);

/**
 * Authenticate request based on the current session state.
 *
 * The session authentication strategy uses the session to restore any login
 * state across requests.  If a login session has been established, `req.user`
 * will be populated with the current user.
 *
 * This strategy is registered automatically by Passport.
 *
 * @param ***REMOVED***Object***REMOVED*** req
 * @param ***REMOVED***Object***REMOVED*** options
 * @api protected
 */
SessionStrategy.prototype.authenticate = function(req, options) ***REMOVED***
  if (!req._passport) ***REMOVED*** return this.error(new Error('passport.initialize() middleware not in use')); ***REMOVED***
  options = options || ***REMOVED******REMOVED***;

  var self = this, 
      su;
  if (req._passport.session) ***REMOVED***
    su = req._passport.session.user;
  ***REMOVED***

  if (su || su === 0) ***REMOVED***
    // NOTE: Stream pausing is desirable in the case where later middleware is
    //       listening for events emitted from request.  For discussion on the
    //       matter, refer to: https://github.com/jaredhanson/passport/pull/106
    
    var paused = options.pauseStream ? pause(req) : null;
    req._passport.instance.deserializeUser(su, req, function(err, user) ***REMOVED***
      if (err) ***REMOVED*** return self.error(err); ***REMOVED***
      if (!user) ***REMOVED***
        delete req._passport.session.user;
        self.pass();
        if (paused) ***REMOVED***
          paused.resume();
        ***REMOVED***
        return;
      ***REMOVED***
      var property = req._passport.instance._userProperty || 'user';
      req[property] = user;
      self.pass();
      if (paused) ***REMOVED***
        paused.resume();
      ***REMOVED***
    ***REMOVED***);
  ***REMOVED*** else ***REMOVED***
    self.pass();
  ***REMOVED***
***REMOVED***;


/**
 * Expose `SessionStrategy`.
 */
module.exports = SessionStrategy;
